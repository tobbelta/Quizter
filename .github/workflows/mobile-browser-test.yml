name: Mobile Browser Testing

on:
  workflow_dispatch: # Manual trigger
    inputs:
      test_url:
        description: 'URL to test (leave empty for local build)'
        required: false
        default: ''

jobs:
  mobile-chrome-test:
    runs-on: macos-14

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Use real Firebase config for functional testing
      run: |
        echo "Using real Firebase config for login testing..."
        # Firebase config is already in the repo

    - name: Build app
      run: npm run build

    - name: Install Puppeteer
      run: npm install puppeteer

    - name: Start local server
      run: |
        npm install -g http-server
        cd build && http-server -p 3000 --cors &
        sleep 5
        echo "Server started on http://localhost:3000"

    - name: Test with Mobile Chrome simulation (Full Game Flow)
      run: |
        cat > mobile-test.js << 'EOF'
        const puppeteer = require('puppeteer');

        (async () => {
          console.log('ðŸš€ Starting mobile Chrome simulation with full login flow...');

          const browser = await puppeteer.launch({
            headless: true,
            args: [
              '--no-sandbox',
              '--disable-setuid-sandbox',
              '--disable-web-security',
              '--disable-features=VizDisplayCompositor'
            ]
          });

          const page = await browser.newPage();

          // iPhone 16 Chrome user agent
          await page.setUserAgent('Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) CriOS/117.0.5938.108 Mobile/15E148 Safari/604.1');

          // iPhone 16 viewport
          await page.setViewport({
            width: 393,
            height: 852,
            deviceScaleFactor: 3,
            isMobile: true,
            hasTouch: true
          });

          try {
            console.log('ðŸ“± Navigating to app...');
            const testUrl = process.env.TEST_URL || 'http://localhost:3000';
            await page.goto(testUrl, { waitUntil: 'networkidle2', timeout: 30000 });

            console.log('ðŸ“¸ Taking initial screenshot...');
            await page.screenshot({
              path: 'screenshots/01-homepage.png',
              fullPage: true
            });

            console.log('ðŸ”‘ Attempting login...');

            // Look for login form or login button
            try {
              await page.waitForSelector('input[type="email"], input[name="email"], [placeholder*="email"]', { timeout: 10000 });

              // Fill in login credentials
              await page.type('input[type="email"], input[name="email"], [placeholder*="email"]', 'tobias.delin@gmail.com');
              await page.type('input[type="password"], input[name="password"], [placeholder*="password"]', 'td11ae');

              console.log('ðŸ“¸ Screenshot after filling credentials...');
              await page.screenshot({
                path: 'screenshots/02-login-filled.png',
                fullPage: true
              });

              // Click login button
              await page.click('button[type="submit"], button:contains("Logga in"), button:contains("Login")');

              // Wait for navigation
              await page.waitForNavigation({ waitUntil: 'networkidle2', timeout: 15000 });

              console.log('âœ… Login successful!');

            } catch (loginError) {
              console.log('âš ï¸ Direct login failed, looking for login page...');

              // Try to find and click a "Login" link first
              try {
                await page.click('a:contains("Logga in"), a:contains("Login"), a[href*="login"]');
                await page.waitForNavigation({ waitUntil: 'networkidle2' });

                // Now try login form again
                await page.waitForSelector('input[type="email"]', { timeout: 5000 });
                await page.type('input[type="email"]', 'tobias.delin@gmail.com');
                await page.type('input[type="password"]', 'td11ae');
                await page.click('button[type="submit"]');
                await page.waitForNavigation({ waitUntil: 'networkidle2' });

              } catch (e) {
                console.log('âŒ Login failed:', e.message);
              }
            }

            console.log('ðŸ“¸ Screenshot after login attempt...');
            await page.screenshot({
              path: 'screenshots/03-after-login.png',
              fullPage: true
            });

            console.log('ðŸƒ Looking for teams page...');

            // Try to navigate to teams or find team creation
            try {
              await page.goto(testUrl + '/teams', { waitUntil: 'networkidle2' });

              console.log('ðŸ“¸ Teams page screenshot...');
              await page.screenshot({
                path: 'screenshots/04-teams-page.png',
                fullPage: true
              });

              // Look for create team button
              const createTeamButton = await page.$('button:contains("Skapa"), button:contains("Create"), a:contains("Skapa")');
              if (createTeamButton) {
                await createTeamButton.click();
                await page.waitForTimeout(2000);

                console.log('ðŸ“¸ Create team page...');
                await page.screenshot({
                  path: 'screenshots/05-create-team.png',
                  fullPage: true
                });

                // Fill team name
                const teamNameInput = await page.$('input[name="teamName"], input[placeholder*="lag"], input[placeholder*="team"]');
                if (teamNameInput) {
                  await teamNameInput.type('Test Team GitHub Actions');

                  // Submit team creation
                  await page.click('button[type="submit"], button:contains("Skapa")');
                  await page.waitForTimeout(3000);

                  console.log('ðŸ“¸ Team created...');
                  await page.screenshot({
                    path: 'screenshots/06-team-created.png',
                    fullPage: true
                  });

                  // Try to start a game
                  const startGameButton = await page.$('button:contains("Starta"), button:contains("Start")');
                  if (startGameButton) {
                    await startGameButton.click();
                    await page.waitForTimeout(5000);

                    console.log('ðŸ“¸ FINAL SCREENSHOT - Game started with header!');
                    await page.screenshot({
                      path: 'screenshots/07-GAME-WITH-HEADER.png',
                      fullPage: true
                    });
                  }
                }
              }

            } catch (teamsError) {
              console.log('âš ï¸ Teams navigation failed:', teamsError.message);
            }

            // Check if we can find the game header
            const headerExists = await page.$('[style*="position: fixed"], .absolute.top-0') !== null;
            console.log('Header found:', headerExists);

            if (headerExists) {
              const headerStyles = await page.evaluate(() => {
                const header = document.querySelector('[style*="position: fixed"], .absolute.top-0');
                if (!header) return null;

                const computed = window.getComputedStyle(header);
                return {
                  backgroundColor: computed.backgroundColor,
                  color: computed.color,
                  position: computed.position,
                  zIndex: computed.zIndex,
                  height: computed.height,
                  display: computed.display,
                  visibility: computed.visibility
                };
              });

              console.log('ðŸŽ¯ HEADER STYLES:', JSON.stringify(headerStyles, null, 2));
            }

            console.log('âœ… Mobile Chrome test completed!');

          } catch (error) {
            console.error('âŒ Test failed:', error);

            // Take error screenshot
            try {
              await page.screenshot({
                path: 'screenshots/99-ERROR.png',
                fullPage: true
              });
            } catch (screenshotError) {
              console.error('Failed to take error screenshot:', screenshotError);
            }

            // Don't throw error, we want to see the screenshots anyway
          } finally {
            await browser.close();
          }
        })();
        EOF

        mkdir -p screenshots
        TEST_URL="${{ github.event.inputs.test_url }}" node mobile-test.js

    - name: Upload mobile test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: mobile-browser-test-results
        path: screenshots/
        retention-days: 30

    - name: Display test summary
      if: always()
      run: |
        echo "## ðŸ“± Mobile Browser Test Results" >> $GITHUB_STEP_SUMMARY
        echo "Screenshots have been uploaded as artifacts." >> $GITHUB_STEP_SUMMARY
        echo "Check the 'mobile-browser-test-results' artifact for:" >> $GITHUB_STEP_SUMMARY
        echo "- Homepage screenshot" >> $GITHUB_STEP_SUMMARY
        echo "- Post-interaction screenshot" >> $GITHUB_STEP_SUMMARY
        echo "- Error screenshot (if any errors occurred)" >> $GITHUB_STEP_SUMMARY

    - name: Cleanup
      if: always()
      run: |
        pkill -f "http-server" || true