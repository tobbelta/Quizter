name: iOS Testing

on:
  workflow_dispatch: # Manual trigger
  push:
    branches: [ main, visa-koordinater ]
  pull_request:
    branches: [ main ]

jobs:
  ios-test:
    runs-on: macos-14 # Latest macOS with Xcode

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Ensure Firebase config exists
      run: |
        if [ -f "src/firebase.js" ]; then
          echo "‚úÖ Firebase config found"
          ls -la src/firebase.js
        else
          echo "‚ùå Firebase config missing, creating it..."
          cat > src/firebase.js << 'EOF'
        import { initializeApp } from "firebase/app";
        import { getAuth } from "firebase/auth";
        import { getFirestore } from "firebase/firestore";

        const firebaseConfig = {
          apiKey: "AIzaSyCwPymSYI2ozAWxq_N7mTWbhLvQ6ygqUtk",
          authDomain: "geoquest-1c461.firebaseapp.com",
          projectId: "geoquest-1c461",
          storageBucket: "geoquest-1c461.appspot.com",
          messagingSenderId: "107222362587",
          appId: "1:107222362587:web:b536e415d8dcbab6915ffe",
          measurementId: "G-Y1XKWY8J4L"
        };

        const app = initializeApp(firebaseConfig);
        export const auth = getAuth(app);
        export const db = getFirestore(app);
        EOF
        fi

    - name: Build app
      run: npm run build

    - name: List available iOS simulators
      run: xcrun simctl list devices available

    - name: Start iOS Simulator (iPhone 15 Pro)
      run: |
        # Start iPhone 15 Pro simulator (closest to iPhone 16)
        DEVICE_ID=$(xcrun simctl list devices available | grep "iPhone 15 Pro (" | head -1 | grep -o '[0-9A-F\-]\{36\}')
        echo "Starting device: $DEVICE_ID"
        xcrun simctl boot $DEVICE_ID
        xcrun simctl list devices booted

    - name: Install and start local server
      run: |
        # Install a simple HTTP server
        npm install -g http-server
        # Start server in background
        cd build && http-server -p 3000 --cors &
        sleep 5
        echo "Server started on http://localhost:3000"

    - name: Install automation tools
      run: |
        npm install puppeteer

    - name: iOS Safari automation with login flow
      run: |
        # Get booted device
        DEVICE_ID=$(xcrun simctl list devices booted | grep "iPhone" | grep -o '[0-9A-F\-]\{36\}' | head -1)
        echo "Using device: $DEVICE_ID"

        # Create screenshots directory
        mkdir -p screenshots

        # Open Safari and navigate to our app
        xcrun simctl openurl $DEVICE_ID "http://localhost:3000"
        sleep 15

        # Take initial screenshot
        xcrun simctl io $DEVICE_ID screenshot screenshots/01-ios-safari-homepage.png

        # Create automation script for iOS Safari
        cat > ios-automation.js << 'EOF'
        const puppeteer = require('puppeteer');

        (async () => {
          console.log('üçé Starting iOS Safari automation...');

          // Since we can't control iOS Simulator Safari directly via puppeteer,
          // we'll use UI automation through simctl
          console.log('üì± iOS Safari is already open, taking scheduled screenshots...');

          // We'll take screenshots at intervals and use simctl to simulate taps
        })();
        EOF

        # Take screenshots at different intervals to capture different states
        sleep 10
        xcrun simctl io $DEVICE_ID screenshot screenshots/02-ios-safari-loaded.png

        # Simulate tapping on login area (approximate coordinates for iPhone 15 Pro)
        # These coordinates are rough estimates for login button area
        xcrun simctl io $DEVICE_ID tap 196 400  # Approximate center-bottom area
        sleep 3
        xcrun simctl io $DEVICE_ID screenshot screenshots/03-ios-safari-after-tap.png

        # Take more screenshots at intervals
        sleep 5
        xcrun simctl io $DEVICE_ID screenshot screenshots/04-ios-safari-mid-flow.png

        sleep 10
        xcrun simctl io $DEVICE_ID screenshot screenshots/05-ios-safari-final.png

        # Try to navigate to teams page directly
        xcrun simctl openurl $DEVICE_ID "http://localhost:3000/teams"
        sleep 10
        xcrun simctl io $DEVICE_ID screenshot screenshots/06-ios-safari-teams.png

        # Try to navigate to a game URL (this might not work without login, but worth trying)
        xcrun simctl openurl $DEVICE_ID "http://localhost:3000/game/test"
        sleep 10
        xcrun simctl io $DEVICE_ID screenshot screenshots/07-ios-safari-game-attempt.png

        echo "‚úÖ iOS Safari screenshots completed"

    - name: Upload iOS screenshots as artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ios-safari-screenshots
        path: screenshots/
        retention-days: 30

    - name: Test Chrome simulation (via user agent)
      run: |
        echo "Testing with Chrome user agent simulation..."
        # This would require more complex setup with puppeteer or similar
        # For now, we document this as future enhancement

    - name: Cleanup
      if: always()
      run: |
        # Kill any running simulators
        xcrun simctl shutdown all || true
        # Kill background processes
        pkill -f "http-server" || true