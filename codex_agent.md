Project Summary (generated by Codex)

[See repository for details.]
Scope
- This summary covers app source under `src/`, Firebase config, Functions, and platform bundles. Markdown files were intentionally excluded from analysis per request.

Architecture
- Frontend: React SPA (Tailwind CSS present via `tailwind.config.js`).
- Data: Firebase Firestore via `src/firebaseClient.js` with gateways and repositories.
- Domain modules:
  - Questions: `src/services/questionService.js`, `src/gateways/firestoreQuestionGateway.js`, `src/repositories/questionRepository.js`, `src/data/questions.js` (seed/static data), plus admin views.
  - Runs and participants: `src/gateways/firestoreRunGateway.js`, `src/services/runFactory.js`, `src/services/routeService.js`, `src/hooks/useRunLocation.js`, UI in `src/views/*Run*` and `src/components/run/RunMap.js`.
  - Payments: `src/services/paymentService.js`, `src/components/payment/PaymentModal.js`, `src/components/admin/PaymentSettings.js`.
  - Analytics/Messaging/Feedback: `src/services/{analyticsService,messageService,feedbackService}.js` with supporting UI.
  - Auth/Context: `src/context/{AuthContext,RunContext}.js` used in `src/App.js` routing/guards.

Data Access Pattern
- Gateways encapsulate Firestore SDK calls.
- Repositories wrap gateways and provide app-level operations.
- Services implement caching, transformation, and language handling, then are consumed by views/components.

Key Flows
- Question bank
  - `questionService` initializes by reading Firestore via `questionRepository.listQuestions()` and maintains an in-memory cache only of Firestore data. Static `QUESTION_BANK` is used only to block deletion of built-ins.
  - Adds use `repository.addManyQuestions` (batched), normalizes language, and sorts by `createdAt` (serverTimestamp fallback).
  - Gateway: `firestoreQuestionGateway` supports list, delete (single/batch), addMany (batch with `serverTimestamp`).

- Runs/participants
  - `firestoreRunGateway` provides CRUD and subscriptions for runs and participants under `runs/{runId}` and `runs/{runId}/participants`.
  - Legacy handling: If a generated run lacks `route`, it triggers `routeService.generateWalkingRoute` and persists the route back.
  - Participant lifecycle: `registerParticipant`, `recordAnswer` (maintains score, progression, completion), `heartbeatParticipant`, `completeRun`, `subscribeParticipants`.

Notable Implementation Details
- Defensive serialization (`serialiseraFörFirestore`) to avoid non-serializable values.
- Status enrichment for participants using `PARTICIPANT_TIMEOUT_MS` and formatted timestamps.
- Real-time listeners via `onSnapshot` on active runs and participants.

Potential Redundancies/Dead Files
- Platform-bundled static builds in `ios/App/App/public/*` and `android/app/src/main/assets/public/*` duplicate `public/*`. Keep only if Capacitor native apps are actively built from these prebaked assets. If web-only deployment is used, these can be removed or regenerated during native builds rather than tracked.
- `public/sw.js` exists while also having build artifacts listed elsewhere; ensure service worker strategy is single-sourced. If CRA build generates SW, consider removing manual `public/sw.js` unless intentional.
- `src/data/questions.js` is only used for built-in checks and not loaded into runtime lists. If built-ins are no longer desired, either remove file and the related guard in `questionService.delete`, or convert built-ins to a Firestore seed/migration.
- `functions/services/{geminiQuestionGenerator,aiQuestionGenerator,openaiQuestionGenerator}.js`: verify which provider is wired in `functions/index.js`. Unused providers can remain as optional integrations but should be referenced in README or removed to reduce surface.
- Super user views: `src/views/SuperUser*.js` (Analytics, Messages, Notifications, Users, AllRuns). Confirm they are routed in `src/App.js`. If not reachable, consider removing or hiding behind feature flags.
- `src/services/migrationService.js` and components under `src/components/migration/*`: ensure the migration prompt/handler is referenced. If one-off migration is complete, these might be removable.

Potential Issues/Risks
- Mixed locale characters in identifiers/comments in `firestoreRunGateway.js` (encoding artifacts). These are safe at runtime but reduce readability and may cause lint/build issues in strict environments.
- Time handling uses ISO strings for participant timestamps and Firestore `serverTimestamp` for questions. Consider normalizing to Firestore Timestamps for consistency.
- `questionService.initialize` runs at module import; race conditions are possible if Firebase client isn’t ready. If issues arise, expose an explicit `init()` and await in app startup.
- `recordAnswer` reads, mutates, and writes participant doc without transactions. For concurrent submissions, use a transaction or `updateDoc` with arrayUnion strategy if applicable.

Suggested Cleanups
- Decide on built-in questions policy. If Firestore-only, remove `src/data/questions.js` and the built-in deletion guard, and add a migration/seed script instead.
- Audit routes in `src/App.js` to verify SuperUser pages are reachable; remove unused pages.
- Confirm Capacitor asset directories are generated as part of native build and not manually maintained; avoid committing large generated assets where possible.
- Consolidate service worker approach (single source of truth).
- Add small repository tests or scripts for gateways where feasible (optional).

Entry Points and Deploy
- Web app entry: `src/index.js`, main component `src/App.js` with routes for runs, admin, login.
- Firebase config: `firebase.json`, `firestore.rules`, `firestore.indexes.json`.
- Functions: `functions/index.js` as Cloud Functions entry, with generator services under `functions/services/`.

Files Worth Keeping (core)
- `src/App.js`, `src/index.js`, `src/firebaseClient.js`.
- `src/services/*` except those verified unused.
- `src/gateways/*`, `src/repositories/*`.
- `src/views/*` that are routed.
- `src/components/*` referenced by views.
- `public/*` (web), minimal icons/manifest.
- Firebase config and Functions if deployed.

Files Possibly Removable (validate first)
- `ios/App/App/public/*`, `android/app/src/main/assets/public/*` if not using native shell builds.
- Unreferenced SuperUser views if not routed.
- `src/components/migration/*` and `src/services/migrationService.js` if migration is done.
- Extra payment or AI provider files not wired in functions/index.

Follow-ups
- If you want, I can produce a concrete deletion PR after confirming which platform targets and features you want to keep.
Stripe Drift & Nyckelrotation
- Prodhemlighet: `STRIPE_SECRET_KEY` (Firebase Functions Secret). Rotera via `firebase functions:secrets:set STRIPE_SECRET_KEY --project geoquest2-7e45c` och därefter `firebase deploy --only functions`.
- Klientnyckel: `REACT_APP_STRIPE_PUBLISHABLE_KEY` i webbbygget. Uppdatera `.env` / CI-variabler och bygg om (`npm run build`).
- Hälsokontroll: `https://europe-west1-geoquest2-7e45c.cloudfunctions.net/getStripeStatus` (GET). Returnerar konto-ID, läge (live/test) och felkod (`STRIPE_AUTH_ERROR`, `STRIPE_UNAVAILABLE`, `STRIPE_KEY_MISSING`).
- Felhantering: `createPaymentIntent` svarar nu med `errorCode` (`STRIPE_AUTH_ERROR`, `STRIPE_UNAVAILABLE`, `STRIPE_RATE_LIMIT`, `PAYMENT_INTENT_FAILED`) och `retryable` flagga. I produktion loggas full Stripe-information men klienten får svensk text.
- Vid `STRIPE_AUTH_ERROR`: rotera båda nycklarna och kör hälsokontrollen tills svaret är `success: true`.
