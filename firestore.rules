rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper-funktioner
    function isAuthenticated() {
      return request.auth != null;
    }

    function isSuperUser() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superuser' ||
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isSuperUser == true);
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Validera run-data (grundläggande validering)
    function isValidRun(data) {
      return // Validera questionCount om det finns
             (!('questionCount' in data.keys()) ||
              (data.questionCount is int && data.questionCount >= 1 && data.questionCount <= 50)) &&
             // Validera lengthMeters om det finns
             (!('lengthMeters' in data.keys()) ||
              (data.lengthMeters is int && data.lengthMeters >= 500 && data.lengthMeters <= 10000)) &&
             // Validera distanceBetweenQuestions om det finns (för distance-based runs)
             (!('distanceBetweenQuestions' in data.keys()) ||
              (data.distanceBetweenQuestions is int && data.distanceBetweenQuestions >= 10 && data.distanceBetweenQuestions <= 5000)) &&
             // Validera type om det finns
             (!('type' in data.keys()) || data.type in ['hosted', 'generated', 'route-based', 'distance-based']) &&
             // Validera difficulty om det finns
             (!('difficulty' in data.keys()) || data.difficulty in ['kid', 'family', 'adult']) &&
             // Validera audience om det finns
             (!('audience' in data.keys()) || data.audience in ['kid', 'family', 'adult']) &&
             // Validera name om det finns
             (!('name' in data.keys()) ||
              (data.name is string && data.name.size() >= 1 && data.name.size() <= 100)) &&
             // Validera joinCode om det finns
             (!('joinCode' in data.keys()) ||
              (data.joinCode is string && data.joinCode.size() == 6));
    }

    // OBS: isValidLocation är tillgänglig för framtida användning om geografisk
    // validering läggs till i runs collection

    // Runs collection
    match /runs/{runId} {
      // Läs: Alla kan läsa rundor (filtrering sker i kod)
      // Detta krävs för att tillåta queries med joinCode
      allow read: if true;

      // Skapa: Alla kan skapa rundor (även anonyma användare)
      // Validera data-format och begränsningar
      allow create: if isValidRun(request.resource.data) &&
                       request.resource.data.createdAt is timestamp &&
                       // Om autentiserad: createdBy måste vara användarens uid
                       // Om anonym: createdBy får vara vilken sträng som helst
                       (!isAuthenticated() || request.resource.data.createdBy == request.auth.uid);

      // Uppdatera: Endast ägare eller SuperUser
      allow update: if (isAuthenticated() && isOwner(resource.data.createdBy)) || isSuperUser();

      // Ta bort: Endast ägare eller SuperUser
      allow delete: if (isAuthenticated() && isOwner(resource.data.createdBy)) || isSuperUser();
    }

    // Questions collection
    match /questions/{questionId} {
      // Läs: Alla kan läsa frågor
      allow read: if true;

      // Skapa/Ta bort: Endast SuperUser eller backend (via service account)
      allow create, delete: if isSuperUser();

      // Uppdatera: SuperUser kan uppdatera allt
      // Autentiserade användare kan endast lägga till rapporter
      allow update: if isSuperUser() ||
                       (isAuthenticated() &&
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reported', 'reportCount', 'reports']));
    }

    // Users collection
    match /users/{userId} {
      // Läs: Användare kan läsa sin egen data, SuperUser kan läsa alla
      allow read: if isOwner(userId) || isSuperUser();

      // Skapa: Användare kan skapa sin egen profil
      allow create: if isOwner(userId) &&
                       request.resource.data.keys().hasAll(['createdAt', 'email']) &&
                       request.resource.data.createdAt is timestamp;

      // Uppdatera: Användare kan uppdatera sin egen data (men inte role om de inte är SuperUser)
      allow update: if isOwner(userId) &&
                       (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']) ||
                        isSuperUser());

      // Ta bort: Användare kan ta bort sig själva, SuperUser kan ta bort alla
      allow delete: if isOwner(userId) || isSuperUser();
    }

    // Messages collection
    match /messages/{messageId} {
      // Läs: Alla kan läsa meddelanden (eftersom vi filtrerar i koden)
      // SuperUser kan läsa alla, andra ser bara meddelanden riktade till dem
      allow read: if true;

      // Skapa: Endast SuperUser kan skapa meddelanden
      // Kräver vissa fält men är flexibel för olika message-format
      allow create: if isSuperUser() &&
                       request.resource.data.createdAt is timestamp;

      // Uppdatera: Alla kan markera meddelanden som lästa eller deleted (soft delete)
      // SuperUser kan uppdatera allt
      allow update: if request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read', 'readAt', 'deleted', 'deletedAt']) ||
                       isSuperUser();

      // Ta bort: Endast SuperUser kan permanent ta bort
      allow delete: if isSuperUser();
    }

    // Feedback collection
    match /feedback/{feedbackId} {
      // Läs: Endast SuperUser kan läsa feedback
      allow read: if isSuperUser();

      // Skapa: Alla kan skicka feedback (även anonyma)
      allow create: if request.resource.data.keys().hasAll(['message', 'createdAt', 'page']) &&
                       request.resource.data.createdAt is timestamp &&
                       request.resource.data.message is string &&
                       request.resource.data.message.size() >= 1 &&
                       request.resource.data.message.size() <= 5000;

      // Uppdatera/Ta bort: Endast SuperUser
      allow update, delete: if isSuperUser();
    }

    // Analytics collection
    match /analytics/{eventId} {
      // Läs: Autentiserade kan läsa sina egna analytics, SuperUser kan läsa alla
      allow read: if isAuthenticated() || isSuperUser();

      // Skapa: Alla kan logga events (även anonyma för spårning)
      // Kräver endast grundfält, tillåter extra metadata
      allow create: if request.resource.data.keys().hasAll(['eventType', 'timestamp', 'deviceId']) &&
                       request.resource.data.timestamp is timestamp &&
                       request.resource.data.eventType is string &&
                       request.resource.data.deviceId is string;

      // Uppdatera: Autentiserade kan uppdatera (för linking deviceId till userId)
      allow update: if isAuthenticated();

      // Ta bort: Endast SuperUser
      allow delete: if isSuperUser();
    }

    // Notifications collection
    match /notifications/{notificationId} {
      // Läs: Endast SuperUser kan läsa notifikationer
      allow read: if isSuperUser();

      // Skapa: Endast backend (via service account) eller SuperUser
      allow create: if isSuperUser();

      // Uppdatera: SuperUser kan uppdatera (t.ex. markera som läst)
      allow update: if isSuperUser();

      // Ta bort: Endast SuperUser
      allow delete: if isSuperUser();
    }

    // Participants sub-collection under runs
    match /runs/{runId}/participants/{participantId} {
      // Läs: Alla kan läsa deltagare i en aktiv runda
      allow read: if true;

      // Skapa: Alla kan gå med i rundor (även anonyma Firebase-användare)
      // Om userId är null (anonym) eller matchar auth.uid (inloggad)
      allow create: if request.resource.data.joinedAt is timestamp &&
                       (request.resource.data.userId == null ||
                        request.resource.data.userId == request.auth.uid);

      // Uppdatera: Endast den egna deltagaren (om autentiserad) eller alla (om anonym)
      allow update: if (resource.data.userId == null ||
                        resource.data.userId == request.auth.uid) ||
                       isSuperUser();

      // Ta bort: Endast ägaren (om autentiserad) eller alla (om anonym) eller SuperUser
      allow delete: if (resource.data.userId == null ||
                        resource.data.userId == request.auth.uid) ||
                       isSuperUser();
    }

    // Error Logs collection
    match /errorLogs/{logId} {
      // Läs: Endast SuperUser kan läsa error logs
      allow read: if isSuperUser();

      // Skapa: Alla kan skapa logs (för error tracking)
      allow create: if request.resource.data.timestamp is timestamp;

      // Uppdatera/Ta bort: Endast SuperUser
      allow update, delete: if isSuperUser();
    }

    // Background tasks collection (Cloud Tasks status)
    match /backgroundTasks/{taskId} {
      // Läs: SuperUser behöver kunna följa köade jobb
      allow read: if isSuperUser();

      // Klienten ska aldrig skriva eller ta bort dessa dokument
      allow write: if false;
    }

    // Default: Neka all annan åtkomst
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
